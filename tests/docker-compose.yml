---
x-test-common: &test-common
  volumes:
    - type: bind
      source: ..
      target: /workspace
  working_dir: /workspace
  depends_on: [mysql, postgres]
  env_file: .env
  environment: &test-common-env
    PIP_ROOT_USER_ACTION: ignore
    SETUPTOOLS_SCM_PRETEND_VERSION: "0"
    PIP_NO_WARN_SCRIPT_LOCATION: "1"
    TEST_URLS: mysql://test:test@mysql/test postgresql://postgres:test@postgres/
    TEST_ASYNC_URLS: mysql+aiomysql://test:test@mysql/test postgresql+asyncpg://postgres:test@postgres/
  build: &test-common-build
    context: .
    args: &test-common-build-args
      APT_SOURCES: ${APT_SOURCES}
  command: [/bin/bash, -eux, /workspace/scripts/run-test.sh]

name: sqlalchemy-dlock-tests

services:
  mysql:
    image: mysql
    ports:
      - "3306:3306"
    environment:
      MYSQL_RANDOM_ROOT_PASSWORD: "1"
      MYSQL_DATABASE: test
      MYSQL_USER: test
      MYSQL_PASSWORD: test

  postgres:
    image: postgres
    ports:
      - "5432:5432"
    environment:
      POSTGRES_PASSWORD: test

  python3.8-sqlalchemy1:
    <<: *test-common
    build:
      <<: *test-common-build
      args:
        <<: *test-common-build-args
        PYTHON_VERSION: "3.8"
    environment:
      <<: *test-common-env
      SQLALCHEMY_REQUIRES: "SQLAlchemy[asyncio]>=1.4.3,<2.0"

  python3.8-sqlalchemy2:
    <<: *test-common
    build:
      <<: *test-common-build
      args:
        <<: *test-common-build-args
        PYTHON_VERSION: "3.8"
    environment:
      <<: *test-common-env
      SQLALCHEMY_REQUIRES: "SQLAlchemy[asyncio]>=2.0,<3.0"

  python3.9-sqlalchemy1:
    build:
      <<: *test-common-build
      args:
        <<: *test-common-build-args
        PYTHON_VERSION: "3.9"
    <<: *test-common
    environment:
      <<: *test-common-env
      SQLALCHEMY_REQUIRES: "SQLAlchemy[asyncio]>=1.4.3,<2.0"

  python3.9-sqlalchemy2:
    <<: *test-common
    build:
      <<: *test-common-build
      args:
        <<: *test-common-build-args
        PYTHON_VERSION: "3.9"
    environment:
      <<: *test-common-env
      SQLALCHEMY_REQUIRES: "SQLAlchemy[asyncio]>=2.0,<3.0"

  python3.10-sqlalchemy1:
    <<: *test-common
    build:
      <<: *test-common-build
      args:
        <<: *test-common-build-args
        PYTHON_VERSION: "3.10"
    environment:
      <<: *test-common-env
      SQLALCHEMY_REQUIRES: "SQLAlchemy[asyncio]>=1.4.3,<2.0"

  python3.10-sqlalchemy2:
    <<: *test-common
    build:
      <<: *test-common-build
      args:
        <<: *test-common-build-args
        PYTHON_VERSION: "3.10"
    environment:
      <<: *test-common-env
      SQLALCHEMY_REQUIRES: "SQLAlchemy[asyncio]>=2.0,<3.0"

  python3.11-sqlalchemy1:
    <<: *test-common
    build:
      <<: *test-common-build
      args:
        <<: *test-common-build-args
        PYTHON_VERSION: "3.11"
    environment:
      <<: *test-common-env
      SQLALCHEMY_REQUIRES: "SQLAlchemy[asyncio]>=1.4.3,<2.0"

  python3.11-sqlalchemy2:
    <<: *test-common
    build:
      <<: *test-common-build
      args:
        <<: *test-common-build-args
        PYTHON_VERSION: "3.11"
    environment:
      <<: *test-common-env
      SQLALCHEMY_REQUIRES: "SQLAlchemy[asyncio]>=2.0,<3.0"

  python3.12-sqlalchemy1:
    <<: *test-common
    build:
      <<: *test-common-build
      args:
        <<: *test-common-build-args
        PYTHON_VERSION: "3.12"
    environment:
      <<: *test-common-env
      SQLALCHEMY_REQUIRES: "SQLAlchemy[asyncio]>=1.4.3,<2.0"

  python3.12-sqlalchemy2:
    <<: *test-common
    build:
      <<: *test-common-build
      args:
        <<: *test-common-build-args
        PYTHON_VERSION: "3.12"
    environment:
      <<: *test-common-env
      SQLALCHEMY_REQUIRES: "SQLAlchemy[asyncio]>=2.0,<3.0"
