name: sqlalchemy-dlock-tests

x-common-environment: &common-environment
  MYSQL_RANDOM_ROOT_PASSWORD: "1"
  MYSQL_DATABASE: test
  MYSQL_USER: test
  MYSQL_PASSWORD: test
  POSTGRES_PASSWORD: test
  MSSQL_SA_PASSWORD: "YourStrongPassword123"

services:
  mysql:
    image: mysql
    environment:
      <<: *common-environment
    ports:
      - "3306:3306"
    healthcheck:
      test: ["CMD-SHELL", "mysqladmin ping -h 127.0.0.1 -u $$MYSQL_USER --password=$$MYSQL_PASSWORD"]

  postgres:
    image: postgres
    environment:
      <<: *common-environment
    ports:
      - "5432:5432"
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres -h 127.0.0.1"]

  mssql:
    image: mcr.microsoft.com/mssql/server:2022-latest
    environment:
      <<: *common-environment
      MSSQL_PID: "Developer"
      MSSQL_TCP_PORT: "1433"
      ACCEPT_EULA: "Y"
    ports:
      - "1433:1433"
    healthcheck:
      test: ["CMD-SHELL", "/opt/mssql-tools18/bin/sqlcmd -C -S localhost -U sa -P $$MSSQL_SA_PASSWORD -Q 'SELECT 1'"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 60s
    # Note: MSSQL container requires at least 2GB RAM to run properly

  python:
    build: .
    volumes:
      - type: bind
        source: ..
        target: /workspace
    working_dir: /workspace
    depends_on:
      mysql:
        condition: service_healthy
      postgres:
        condition: service_healthy
      mssql:
        condition: service_healthy
    environment:
      <<: *common-environment
    env_file: .env
    command: [/bin/bash, /workspace/scripts/run-test.sh]
