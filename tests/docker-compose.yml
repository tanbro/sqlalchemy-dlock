---
x-test-common: &test-common
  volumes:
    - type: bind
      source: ..
      target: /work
  working_dir: /work
  depends_on:
    - mysql
    - postgres
  env_file:
    - .env
  environment: &test-common-env
    PIP_ROOT_USER_ACTION: ignore
    PIP_DISABLE_PIP_VERSION_CHECK: true
    TEST_URLS: mysql://test:test@mysql/test postgresql://postgres:test@postgres/
    TEST_ASYNC_URLS: mysql+aiomysql://test:test@mysql/test postgresql+asyncpg://postgres:test@postgres/
  build: &test-common-build
    context: .
    args: &test-common-build-args
      APT_SOURCES: ${APT_SOURCES}
  command:
    - /bin/bash
    - -c
    - |
      set -e
      python -m pip install --upgrade --find-links /work/dist --pre sqlalchemy-dlock $(printenv SQLALCHEMY_REQUIRES) -r /work/tests/requirements.txt
      /bin/bash -e scripts/wait-for-postgres.sh postgres test
      /bin/bash -e scripts/wait-for-mysql.sh mysql test test test
      python -B -m unittest -cfv

services:
  mysql:
    image: mysql
    ports:
      - "3306:3306"
    environment:
      MYSQL_ROOT_HOST: "%"
      MYSQL_RANDOM_ROOT_PASSWORD: "1"
      MYSQL_DATABASE: test
      MYSQL_USER: test
      MYSQL_PASSWORD: test

  postgres:
    image: postgres
    ports:
      - "5432:5432"
    environment:
      POSTGRES_PASSWORD: test

  python3.7-sqlalchemy1:
    <<: *test-common
    build:
      <<: *test-common-build
      args:
        <<: *test-common-build-args
        PYTHON_VERSION: "3.7"
    environment:
      <<: *test-common-env
      SQLALCHEMY_REQUIRES: "SQLAlchemy>=1.4.3,<2.0" # no asynio tests for py37

  python3.7-sqlalchemy2:
    <<: *test-common
    build:
      <<: *test-common-build
      args:
        <<: *test-common-build-args
        PYTHON_VERSION: "3.7"
    environment:
      <<: *test-common-env
      SQLALCHEMY_REQUIRES: "SQLAlchemy>=2.0,<3.0" # no asynio tests for py37

  python3.8-sqlalchemy1:
    <<: *test-common
    build:
      <<: *test-common-build
      args:
        <<: *test-common-build-args
        PYTHON_VERSION: "3.8"
    environment:
      <<: *test-common-env
      SQLALCHEMY_REQUIRES: "SQLAlchemy[asyncio]>=1.4.3,<2.0"

  python3.8-sqlalchemy2:
    <<: *test-common
    build:
      <<: *test-common-build
      args:
        <<: *test-common-build-args
        PYTHON_VERSION: "3.8"
    environment:
      <<: *test-common-env
      SQLALCHEMY_REQUIRES: "SQLAlchemy[asyncio]>=2.0,<3.0"

  python3.9-sqlalchemy1:
    build:
      <<: *test-common-build
      args:
        <<: *test-common-build-args
        PYTHON_VERSION: "3.9"
    <<: *test-common
    environment:
      <<: *test-common-env
      SQLALCHEMY_REQUIRES: "SQLAlchemy[asyncio]>=1.4.3,<2.0"

  python3.9-sqlalchemy2:
    <<: *test-common
    build:
      <<: *test-common-build
      args:
        <<: *test-common-build-args
        PYTHON_VERSION: "3.9"
    environment:
      <<: *test-common-env
      SQLALCHEMY_REQUIRES: "SQLAlchemy[asyncio]>=2.0,<3.0"

  python3.10-sqlalchemy1:
    <<: *test-common
    build:
      <<: *test-common-build
      args:
        <<: *test-common-build-args
        PYTHON_VERSION: "3.10"
    environment:
      <<: *test-common-env
      SQLALCHEMY_REQUIRES: "SQLAlchemy[asyncio]>=1.4.3,<2.0"

  python3.10-sqlalchemy2:
    <<: *test-common
    build:
      <<: *test-common-build
      args:
        <<: *test-common-build-args
        PYTHON_VERSION: "3.10"
    environment:
      <<: *test-common-env
      SQLALCHEMY_REQUIRES: "SQLAlchemy[asyncio]>=2.0,<3.0"

  python3.11-sqlalchemy1:
    <<: *test-common
    build:
      <<: *test-common-build
      args:
        <<: *test-common-build-args
        PYTHON_VERSION: "3.11"
    environment:
      <<: *test-common-env
      SQLALCHEMY_REQUIRES: "SQLAlchemy[asyncio]>=1.4.3,<2.0"

  python3.11-sqlalchemy2:
    <<: *test-common
    build:
      <<: *test-common-build
      args:
        <<: *test-common-build-args
        PYTHON_VERSION: "3.11"
    environment:
      <<: *test-common-env
      SQLALCHEMY_REQUIRES: "SQLAlchemy[asyncio]>=2.0,<3.0"
